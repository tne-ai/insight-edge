import pandas as pd
from tne.TNE import TNE

# Initialize TNE session
session = TNE(uid=UID, bucket_name=BUCKET, project=PROJECT, version=VERSION)

# Load data from CSV file
df = session.get_object("handbags-shopping_list-no_run-1_1-with_periods_cleaned.csv")

# Convert 'period' column to datetime and extract month and year
df['period'] = pd.to_datetime(df['period'], format='%Y%m')
df['month'] = df['period'].dt.month
df['year'] = df['period'].dt.year

# Filter data for last 3 months (assuming last 3 unique months in the data)
last_three_months = df['period'].nunique()
last_three_months = df['period'].unique()[-3:]

# Filter data for crossbody bags in last 3 months
crossbody_bags_last_three_months = df[(df['product_subgroup_desc'] == 'Crossbody bag') & 
                                       (df['period'].isin(last_three_months))]

# Calculate total discount value using the given formula
crossbody_bags_last_three_months['discount'] = (crossbody_bags_last_three_months['standard_selling_price'] - 
                                                crossbody_bags_last_three_months['aur']) * \
                                               crossbody_bags_last_three_months['sales']

# Group by month and year, and calculate total discount value
result = crossbody_bags_last_three_months.groupby(['year', 'month'])['discount'].sum().reset_index()

# Rename columns for better understanding
result.columns = ['Year', 'Month', 'Total Discount Value']

# Limit to 12 rows if more than 12 exist
result = result.head(12)