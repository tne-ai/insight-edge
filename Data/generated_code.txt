import pandas as pd
from tne.TNE import TNE

# Initialize TNE session
session = TNE(uid=UID, bucket_name=BUCKET, project=PROJECT, version=VERSION)

# Load data from CSV file
df = session.get_object("handbags-shopping_list-no_run-1_1-with_periods_cleaned.csv")

# Ensure 'period' column is of integer type for sorting
df['period'] = df['period'].astype(int)

# Filter data to the last period available
last_period = df['period'].max()
df_last_period = df[df['period'] == last_period]

# Calculate Sell-Through Rate (STR)
df_last_period['sell_through_rate'] = (df_last_period['sales'] / (df_last_period['sales'] + df_last_period['end_inv'])) * 100

# Identify High Inventory Stock (top 10 by ending inventory)
high_inventory_stock = df_last_period.nlargest(10, 'end_inv')

# Select relevant columns for output
result = high_inventory_stock[['style_colour_desc', 'end_inv', 'sell_through_rate']]

# Ensure result is not more than 12 items as per general-rules
result = result.head(12)