from tne.TNE import TNE
import pandas as pd

session = TNE(uid=UID, bucket_name=BUCKET, project=PROJECT, version=VERSION)
df = session.get_object("handbags-shopping_list-no_run-1_1-with_periods_cleaned.csv")

# Convert period to datetime for easier manipulation
df['period'] = pd.to_datetime(df['period'], format='%Y%m')

# Filter data for October
october_data = df[df['month'] == 'October']

# Get the last 11 periods before October
last_11_periods = df[df['period'] < pd.to_datetime('2022-10-01')].groupby('style_colour_desc')['sales'].mean().reset_index()

# Merge October data with the average sales of the last 11 periods
merged_data = october_data.merge(last_11_periods, on='style_colour_desc', suffixes=('_oct', '_avg'))

# Calculate percentage increase
merged_data['percentage_increase'] = ((merged_data['sales_oct'] - merged_data['sales_avg']) / merged_data['sales_avg']) * 100

# Sort by percentage increase in descending order and get top 10
rising_styles = merged_data.sort_values(by='percentage_increase', ascending=False).head(10)

# Select relevant columns for the result
result = rising_styles[['style_colour_desc', 'sales_oct', 'sales_avg', 'percentage_increase']]